/* USER CODE BEGIN Header */
/**
 ******************************************************************************
 * @file           : main.c
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 *SWO print tutorial: https://youtu.be/iR34qmfyZtU?si=ymslVCKYRUU1sUiR
 *
 ******************************************************************************
 */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <math.h>
#include <stdio.h>

/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define PI 3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679
#define TAU (2.0 * PI)
#define BUFFER_SIZE 128 //Phil's lab used 128
#define INT16_TO_FLOAT 1.0f/(32767.0f)
#define FLOAT_TO_INT16 32767.0f
#define FS 48095.0f //see .ioc see for 48 kHz inaccuracy WAS 48000
#define LOOKUPSIZE 4096
#define LOG_E2 (1.4426950408889634f)	// 1.0 / math.log(2.0)


// DAC PARAMS
#define DACADDR 0x94
#define CS43L22_REG_ID                              0x01
#define CS43L22_REG_Power_Ctl_1                     0x02
#define CS43L22_REG_Power_Ctl_2                     0x04
#define CS43L22_REG_Clocking_Ctl                    0x05
#define CS43L22_REG_Interface_Ctl_1                 0x06
#define CS43L22_REG_Interface_Ctl_2                 0x07
#define CS43L22_REG_Passthrough_A_Select            0x08
#define CS43L22_REG_Passthrough_B_Select            0x09
#define CS43L22_REG_Analog_ZC_and_SR_Settings       0x0A
#define CS43L22_REG_Passthrough_Gang_Control        0x0C
#define CS43L22_REG_Playback_Ctl_1                  0x0D
#define CS43L22_REG_Misc_Ctl                        0x0E
#define CS43L22_REG_Playback_Ctl_2                  0x0F
#define CS43L22_REG_Passthrough_A_Vol               0x14
#define CS43L22_REG_Passthrough_B_Vol               0x15
#define CS43L22_REG_PCMA_Vol                        0x1A
#define CS43L22_REG_PCMB_Vol                        0x1B
#define CS43L22_REG_BEEP_Freq_On_Time               0x1C
#define CS43L22_REG_BEEP_Vol_Off_Time               0x1D
#define CS43L22_REG_BEEP_Tone_Cfg                   0x1E
#define CS43L22_REG_Tone_Ctl                        0x1F
#define CS43L22_REG_Master_A_Vol                    0x20
#define CS43L22_REG_Master_B_Vol                    0x21
#define CS43L22_REG_Headphone_A_Volume              0x22
#define CS43L22_REG_Headphone_B_Volume              0x23
#define CS43L22_REG_Speaker_A_Volume                0x24
#define CS43L22_REG_Speaker_B_Volume                0x25
#define CS43L22_REG_Channel_Mixer_Swap              0x26
#define CS43L22_REG_Limit_Ctl_1_Thresholds          0x27
#define CS43L22_REG_Limit_Ctl_2_Release_Rate        0x28
#define CS43L22_REG_Limiter_Attack_Rate             0x29
#define CS43L22_REG_Overflow_Clock_Status           0x2E
#define CS43L22_REG_Battery_Compensation            0x2F
#define CS43L22_REG_VP_Battery_Level                0x30
#define CS43L22_REG_Speaker_Status                  0x31
#define CS43L22_REG_Charge_Pump_Frequency           0x34


/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
I2C_HandleTypeDef hi2c1;

I2S_HandleTypeDef hi2s3;
DMA_HandleTypeDef hdma_spi3_tx;

SPI_HandleTypeDef hspi1;

PCD_HandleTypeDef hpcd_USB_OTG_FS;

/* USER CODE BEGIN PV */
int16_t dacData[BUFFER_SIZE];

static volatile int16_t *outBufPtr = &dacData[0];
volatile uint8_t dataReadyFlag = 0; // added this = 0
volatile uint8_t writeFirstHalf = 0;
volatile uint64_t ticks = 0; //number of samples output
volatile uint64_t loops = 0;
int8_t odeToJoy[] = {4,4,5,7,7,5,4,2,0,0,2,4,4,4,2,2,4,4,5,7,7,5,4,2,0,0,2,4,2,2,0,0};
//TODO understand phase issues for non-integer frequencies.
//int8_t odeToJoy[] = {0,0,12,12,0,0,-12,-12,0,0,12,12,0,0,-12,-12,};
uint8_t lenJoy = sizeof(odeToJoy);

float ATTACK_TIME = 0.2; //units: seconds
float DECAY_TIME = 0.4; // time constant tau: seconds
float RELEASE_TIME = 0.4; // time constant tau: seconds
float SUSTAIN_LEVEL = 0.0;

float input_scale;

uint8_t prevNoteInd = 0;
volatile uint64_t ticksNote = 0;

double expTest[12000];

const int16_t sineLookupTable[] = { //4096 entries. from https://deepbluembedded.com/sine-lookup-table-generator-calculator/
		0, 50, 101, 151, 201, 251, 302, 352, 402, 452, 503, 553, 603, 653, 704, 754, 804, 854, 905, 955, 1005, 1055, 1106, 1156, 1206, 1256, 1307, 1357, 1407, 1457, 1507, 1558, 1608, 1658, 1708, 1758, 1809, 1859, 1909, 1959, 2009, 2059, 2110, 2160, 2210, 2260, 2310, 2360, 2410, 2461, 2511, 2561, 2611, 2661, 2711, 2761, 2811, 2861, 2911, 2962, 3012, 3062, 3112, 3162, 3212, 3262, 3312, 3362, 3412, 3462, 3512, 3562, 3612, 3662, 3712, 3761, 3811, 3861, 3911, 3961, 4011, 4061, 4111, 4161, 4210, 4260, 4310, 4360, 4410, 4460, 4509, 4559, 4609, 4659, 4708, 4758, 4808, 4858, 4907, 4957, 5007, 5056, 5106, 5156, 5205, 5255, 5305, 5354, 5404, 5453, 5503, 5552, 5602, 5651, 5701, 5750, 5800, 5849, 5899, 5948, 5998, 6047, 6096, 6146, 6195, 6245, 6294, 6343, 6393, 6442, 6491, 6540, 6590, 6639, 6688, 6737, 6786, 6836, 6885, 6934, 6983, 7032, 7081, 7130, 7179, 7228, 7277, 7326, 7375, 7424, 7473, 7522, 7571, 7620, 7669, 7718, 7767, 7815, 7864, 7913, 7962, 8010, 8059, 8108, 8157, 8205, 8254, 8303, 8351, 8400, 8448, 8497, 8545, 8594, 8642, 8691, 8739, 8788, 8836, 8885, 8933, 8981, 9030, 9078, 9126, 9175, 9223, 9271, 9319, 9367, 9416, 9464, 9512, 9560, 9608, 9656, 9704, 9752, 9800, 9848, 9896, 9944, 9992, 10039, 10087, 10135, 10183, 10231, 10278, 10326, 10374, 10421, 10469, 10517, 10564, 10612, 10659, 10707, 10754, 10802, 10849, 10897, 10944, 10992, 11039, 11086, 11133, 11181, 11228, 11275, 11322, 11370, 11417, 11464, 11511, 11558, 11605, 11652, 11699, 11746, 11793, 11840, 11886, 11933, 11980, 12027, 12074, 12120, 12167, 12214, 12260, 12307, 12353, 12400, 12446, 12493, 12539, 12586, 12632, 12679, 12725, 12771, 12817, 12864, 12910, 12956, 13002, 13048, 13094, 13141, 13187, 13233, 13279, 13324, 13370, 13416, 13462, 13508, 13554, 13599, 13645, 13691, 13736, 13782, 13828, 13873, 13919, 13964, 14010, 14055, 14101, 14146, 14191, 14236, 14282, 14327, 14372, 14417, 14462, 14507, 14553, 14598, 14643, 14688, 14732, 14777, 14822, 14867, 14912, 14956, 15001, 15046, 15090, 15135, 15180, 15224, 15269, 15313, 15358, 15402, 15446, 15491, 15535, 15579, 15623, 15667, 15712, 15756, 15800, 15844, 15888, 15932, 15976, 16019, 16063, 16107, 16151, 16195, 16238, 16282, 16325, 16369, 16413, 16456, 16499, 16543, 16586, 16630, 16673, 16716, 16759, 16802, 16846, 16889, 16932, 16975, 17018, 17061, 17104, 17146, 17189, 17232, 17275, 17317, 17360, 17403, 17445, 17488, 17530, 17573, 17615, 17657, 17700, 17742, 17784, 17827, 17869, 17911, 17953, 17995, 18037, 18079, 18121, 18163, 18204, 18246, 18288, 18330, 18371, 18413, 18454, 18496, 18537, 18579, 18620, 18661, 18703, 18744, 18785, 18826,
		18868, 18909, 18950, 18991, 19032, 19072, 19113, 19154, 19195, 19236, 19276, 19317, 19357, 19398, 19438, 19479, 19519, 19560, 19600, 19640, 19680, 19721, 19761, 19801, 19841, 19881, 19921, 19961, 20000, 20040, 20080, 20120, 20159, 20199, 20238, 20278, 20317, 20357, 20396, 20436, 20475, 20514, 20553, 20592, 20631, 20670, 20709, 20748, 20787, 20826, 20865, 20904, 20942, 20981, 21019, 21058, 21096, 21135, 21173, 21212, 21250, 21288, 21326, 21364, 21403, 21441, 21479, 21516, 21554, 21592, 21630, 21668, 21705, 21743, 21781, 21818, 21856, 21893, 21930, 21968, 22005, 22042, 22079, 22116, 22154, 22191, 22227, 22264, 22301, 22338, 22375, 22411, 22448, 22485, 22521, 22558, 22594, 22631, 22667, 22703, 22739, 22776, 22812, 22848, 22884, 22920, 22956, 22991, 23027, 23063, 23099, 23134, 23170, 23205, 23241, 23276, 23311, 23347, 23382, 23417, 23452, 23487, 23522, 23557, 23592, 23627, 23662, 23697, 23731, 23766, 23801, 23835, 23870, 23904, 23938, 23973, 24007, 24041, 24075, 24109, 24143, 24177, 24211, 24245, 24279, 24312, 24346, 24380, 24413, 24447, 24480, 24514, 24547, 24580, 24613, 24647, 24680, 24713, 24746, 24779, 24811, 24844, 24877, 24910, 24942, 24975, 25007, 25040, 25072, 25105, 25137, 25169, 25201, 25233, 25265, 25297, 25329, 25361, 25393, 25425, 25456, 25488, 25519, 25551, 25582, 25614, 25645, 25676, 25708, 25739, 25770, 25801, 25832, 25863, 25893, 25924, 25955, 25986, 26016, 26047, 26077, 26108, 26138, 26168, 26198, 26229, 26259, 26289, 26319, 26349, 26378, 26408, 26438, 26468, 26497, 26527, 26556, 26586, 26615, 26644, 26674, 26703, 26732, 26761, 26790, 26819, 26848, 26876, 26905, 26934, 26962, 26991, 27019, 27048, 27076, 27104, 27133, 27161, 27189, 27217, 27245, 27273, 27300, 27328, 27356, 27384, 27411, 27439, 27466, 27493, 27521, 27548, 27575, 27602, 27629, 27656, 27683, 27710, 27737, 27764, 27790, 27817, 27843, 27870, 27896, 27923, 27949, 27975, 28001, 28027, 28053, 28079, 28105, 28131, 28157, 28182, 28208, 28234, 28259, 28284, 28310, 28335, 28360, 28385, 28411, 28436, 28460, 28485, 28510, 28535, 28560, 28584, 28609, 28633, 28658, 28682, 28706, 28730, 28755, 28779, 28803, 28827, 28850, 28874, 28898, 28922, 28945, 28969, 28992, 29016, 29039, 29062, 29085, 29108, 29131, 29154, 29177, 29200, 29223, 29246, 29268, 29291, 29313, 29336, 29358, 29380, 29403, 29425, 29447, 29469, 29491, 29513, 29534, 29556, 29578, 29599, 29621, 29642, 29664, 29685, 29706, 29728, 29749, 29770, 29791, 29812, 29832, 29853, 29874, 29894, 29915, 29936, 29956, 29976, 29997, 30017, 30037, 30057, 30077, 30097, 30117, 30136, 30156, 30176, 30195, 30215, 30234, 30253, 30273, 30292, 30311, 30330, 30349, 30368, 30387, 30406, 30424, 30443, 30462, 30480, 30498, 30517, 30535, 30553, 30571, 30589, 30607, 30625, 30643, 30661, 30679, 30696, 30714, 30731, 30749, 30766, 30783, 30800, 30818, 30835,
		30852, 30868, 30885, 30902, 30919, 30935, 30952, 30968, 30985, 31001, 31017, 31033, 31050, 31066, 31082, 31097, 31113, 31129, 31145, 31160, 31176, 31191, 31206, 31222, 31237, 31252, 31267, 31282, 31297, 31312, 31327, 31341, 31356, 31371, 31385, 31400, 31414, 31428, 31442, 31456, 31470, 31484, 31498, 31512, 31526, 31539, 31553, 31567, 31580, 31593, 31607, 31620, 31633, 31646, 31659, 31672, 31685, 31698, 31710, 31723, 31736, 31748, 31760, 31773, 31785, 31797, 31809, 31821, 31833, 31845, 31857, 31869, 31880, 31892, 31903, 31915, 31926, 31937, 31949, 31960, 31971, 31982, 31993, 32004, 32014, 32025, 32036, 32046, 32057, 32067, 32077, 32087, 32098, 32108, 32118, 32128, 32137, 32147, 32157, 32166, 32176, 32185, 32195, 32204, 32213, 32223, 32232, 32241, 32250, 32258, 32267, 32276, 32285, 32293, 32302, 32310, 32318, 32327, 32335, 32343, 32351, 32359, 32367, 32375, 32382, 32390, 32397, 32405, 32412, 32420, 32427, 32434, 32441, 32448, 32455, 32462, 32469, 32476, 32482, 32489, 32495, 32502, 32508, 32514, 32521, 32527, 32533, 32539, 32545, 32550, 32556, 32562, 32567, 32573, 32578, 32584, 32589, 32594, 32599, 32604, 32609, 32614, 32619, 32624, 32628, 32633, 32637, 32642, 32646, 32650, 32655, 32659, 32663, 32667, 32671, 32674, 32678, 32682, 32685, 32689, 32692, 32696, 32699, 32702, 32705, 32708, 32711, 32714, 32717, 32720, 32722, 32725, 32728, 32730, 32732, 32735, 32737, 32739, 32741, 32743, 32745, 32747, 32748, 32750, 32752, 32753, 32755, 32756, 32757, 32758, 32759, 32760, 32761, 32762, 32763, 32764, 32765, 32765, 32766, 32766, 32766, 32767, 32767, 32767, 32767, 32767, 32767, 32767, 32766, 32766, 32766, 32765, 32765, 32764, 32763, 32762, 32761, 32760, 32759, 32758, 32757, 32756, 32755, 32753, 32752, 32750, 32748, 32747, 32745, 32743, 32741, 32739, 32737, 32735, 32732, 32730, 32728, 32725, 32722, 32720, 32717, 32714, 32711, 32708, 32705, 32702, 32699, 32696, 32692, 32689, 32685, 32682, 32678, 32674, 32671, 32667, 32663, 32659, 32655, 32650, 32646, 32642, 32637, 32633, 32628, 32624, 32619, 32614, 32609, 32604, 32599, 32594, 32589, 32584, 32578, 32573, 32567, 32562, 32556, 32550, 32545, 32539, 32533, 32527, 32521, 32514, 32508, 32502, 32495, 32489, 32482, 32476, 32469, 32462, 32455, 32448, 32441, 32434, 32427, 32420, 32412, 32405, 32397, 32390, 32382, 32375, 32367, 32359, 32351, 32343, 32335, 32327, 32318, 32310, 32302, 32293, 32285, 32276, 32267, 32258, 32250, 32241, 32232, 32223, 32213, 32204, 32195, 32185, 32176, 32166, 32157, 32147, 32137, 32128, 32118, 32108, 32098, 32087, 32077, 32067, 32057, 32046, 32036, 32025, 32014, 32004, 31993, 31982, 31971, 31960, 31949, 31937, 31926, 31915, 31903, 31892, 31880, 31869, 31857, 31845, 31833, 31821, 31809, 31797, 31785, 31773, 31760, 31748, 31736, 31723, 31710, 31698, 31685, 31672, 31659, 31646, 31633, 31620, 31607, 31593,
		31580, 31567, 31553, 31539, 31526, 31512, 31498, 31484, 31470, 31456, 31442, 31428, 31414, 31400, 31385, 31371, 31356, 31341, 31327, 31312, 31297, 31282, 31267, 31252, 31237, 31222, 31206, 31191, 31176, 31160, 31145, 31129, 31113, 31097, 31082, 31066, 31050, 31033, 31017, 31001, 30985, 30968, 30952, 30935, 30919, 30902, 30885, 30868, 30852, 30835, 30818, 30800, 30783, 30766, 30749, 30731, 30714, 30696, 30679, 30661, 30643, 30625, 30607, 30589, 30571, 30553, 30535, 30517, 30498, 30480, 30462, 30443, 30424, 30406, 30387, 30368, 30349, 30330, 30311, 30292, 30273, 30253, 30234, 30215, 30195, 30176, 30156, 30136, 30117, 30097, 30077, 30057, 30037, 30017, 29997, 29976, 29956, 29936, 29915, 29894, 29874, 29853, 29832, 29812, 29791, 29770, 29749, 29728, 29706, 29685, 29664, 29642, 29621, 29599, 29578, 29556, 29534, 29513, 29491, 29469, 29447, 29425, 29403, 29380, 29358, 29336, 29313, 29291, 29268, 29246, 29223, 29200, 29177, 29154, 29131, 29108, 29085, 29062, 29039, 29016, 28992, 28969, 28945, 28922, 28898, 28874, 28850, 28827, 28803, 28779, 28755, 28730, 28706, 28682, 28658, 28633, 28609, 28584, 28560, 28535, 28510, 28485, 28460, 28436, 28411, 28385, 28360, 28335, 28310, 28284, 28259, 28234, 28208, 28182, 28157, 28131, 28105, 28079, 28053, 28027, 28001, 27975, 27949, 27923, 27896, 27870, 27843, 27817, 27790, 27764, 27737, 27710, 27683, 27656, 27629, 27602, 27575, 27548, 27521, 27493, 27466, 27439, 27411, 27384, 27356, 27328, 27300, 27273, 27245, 27217, 27189, 27161, 27133, 27104, 27076, 27048, 27019, 26991, 26962, 26934, 26905, 26876, 26848, 26819, 26790, 26761, 26732, 26703, 26674, 26644, 26615, 26586, 26556, 26527, 26497, 26468, 26438, 26408, 26378, 26349, 26319, 26289, 26259, 26229, 26198, 26168, 26138, 26108, 26077, 26047, 26016, 25986, 25955, 25924, 25893, 25863, 25832, 25801, 25770, 25739, 25708, 25676, 25645, 25614, 25582, 25551, 25519, 25488, 25456, 25425, 25393, 25361, 25329, 25297, 25265, 25233, 25201, 25169, 25137, 25105, 25072, 25040, 25007, 24975, 24942, 24910, 24877, 24844, 24811, 24779, 24746, 24713, 24680, 24647, 24613, 24580, 24547, 24514, 24480, 24447, 24413, 24380, 24346, 24312, 24279, 24245, 24211, 24177, 24143, 24109, 24075, 24041, 24007, 23973, 23938, 23904, 23870, 23835, 23801, 23766, 23731, 23697, 23662, 23627, 23592, 23557, 23522, 23487, 23452, 23417, 23382, 23347, 23311, 23276, 23241, 23205, 23170, 23134, 23099, 23063, 23027, 22991, 22956, 22920, 22884, 22848, 22812, 22776, 22739, 22703, 22667, 22631, 22594, 22558, 22521, 22485, 22448, 22411, 22375, 22338, 22301, 22264, 22227, 22191, 22154, 22116, 22079, 22042, 22005, 21968, 21930, 21893, 21856, 21818, 21781, 21743, 21705, 21668, 21630, 21592, 21554, 21516, 21479, 21441, 21403, 21364, 21326, 21288, 21250, 21212, 21173, 21135, 21096, 21058, 21019, 20981, 20942, 20904, 20865, 20826,
		20787, 20748, 20709, 20670, 20631, 20592, 20553, 20514, 20475, 20436, 20396, 20357, 20317, 20278, 20238, 20199, 20159, 20120, 20080, 20040, 20000, 19961, 19921, 19881, 19841, 19801, 19761, 19721, 19680, 19640, 19600, 19560, 19519, 19479, 19438, 19398, 19357, 19317, 19276, 19236, 19195, 19154, 19113, 19072, 19032, 18991, 18950, 18909, 18868, 18826, 18785, 18744, 18703, 18661, 18620, 18579, 18537, 18496, 18454, 18413, 18371, 18330, 18288, 18246, 18204, 18163, 18121, 18079, 18037, 17995, 17953, 17911, 17869, 17827, 17784, 17742, 17700, 17657, 17615, 17573, 17530, 17488, 17445, 17403, 17360, 17317, 17275, 17232, 17189, 17146, 17104, 17061, 17018, 16975, 16932, 16889, 16846, 16802, 16759, 16716, 16673, 16630, 16586, 16543, 16499, 16456, 16413, 16369, 16325, 16282, 16238, 16195, 16151, 16107, 16063, 16019, 15976, 15932, 15888, 15844, 15800, 15756, 15712, 15667, 15623, 15579, 15535, 15491, 15446, 15402, 15358, 15313, 15269, 15224, 15180, 15135, 15090, 15046, 15001, 14956, 14912, 14867, 14822, 14777, 14732, 14688, 14643, 14598, 14553, 14507, 14462, 14417, 14372, 14327, 14282, 14236, 14191, 14146, 14101, 14055, 14010, 13964, 13919, 13873, 13828, 13782, 13736, 13691, 13645, 13599, 13554, 13508, 13462, 13416, 13370, 13324, 13279, 13233, 13187, 13141, 13094, 13048, 13002, 12956, 12910, 12864, 12817, 12771, 12725, 12679, 12632, 12586, 12539, 12493, 12446, 12400, 12353, 12307, 12260, 12214, 12167, 12120, 12074, 12027, 11980, 11933, 11886, 11840, 11793, 11746, 11699, 11652, 11605, 11558, 11511, 11464, 11417, 11370, 11322, 11275, 11228, 11181, 11133, 11086, 11039, 10992, 10944, 10897, 10849, 10802, 10754, 10707, 10659, 10612, 10564, 10517, 10469, 10421, 10374, 10326, 10278, 10231, 10183, 10135, 10087, 10039, 9992, 9944, 9896, 9848, 9800, 9752, 9704, 9656, 9608, 9560, 9512, 9464, 9416, 9367, 9319, 9271, 9223, 9175, 9126, 9078, 9030, 8981, 8933, 8885, 8836, 8788, 8739, 8691, 8642, 8594, 8545, 8497, 8448, 8400, 8351, 8303, 8254, 8205, 8157, 8108, 8059, 8010, 7962, 7913, 7864, 7815, 7767, 7718, 7669, 7620, 7571, 7522, 7473, 7424, 7375, 7326, 7277, 7228, 7179, 7130, 7081, 7032, 6983, 6934, 6885, 6836, 6786, 6737, 6688, 6639, 6590, 6540, 6491, 6442, 6393, 6343, 6294, 6245, 6195, 6146, 6096, 6047, 5998, 5948, 5899, 5849, 5800, 5750, 5701, 5651, 5602, 5552, 5503, 5453, 5404, 5354, 5305, 5255, 5205, 5156, 5106, 5056, 5007, 4957, 4907, 4858, 4808, 4758, 4708, 4659, 4609, 4559, 4509, 4460, 4410, 4360, 4310, 4260, 4210, 4161, 4111, 4061, 4011, 3961, 3911, 3861, 3811, 3761, 3712, 3662, 3612, 3562, 3512, 3462, 3412, 3362, 3312, 3262, 3212, 3162, 3112, 3062, 3012, 2962, 2911, 2861, 2811, 2761, 2711, 2661, 2611, 2561, 2511, 2461,
		2410, 2360, 2310, 2260, 2210, 2160, 2110, 2059, 2009, 1959, 1909, 1859, 1809, 1758, 1708, 1658, 1608, 1558, 1507, 1457, 1407, 1357, 1307, 1256, 1206, 1156, 1106, 1055, 1005, 955, 905, 854, 804, 754, 704, 653, 603, 553, 503, 452, 402, 352, 302, 251, 201, 151, 101, 50, 0, -50, -101, -151, -201, -251, -302, -352, -402, -452, -503, -553, -603, -653, -704, -754, -804, -854, -905, -955, -1005, -1055, -1106, -1156, -1206, -1256, -1307, -1357, -1407, -1457, -1507, -1558, -1608, -1658, -1708, -1758, -1809, -1859, -1909, -1959, -2009, -2059, -2110, -2160, -2210, -2260, -2310, -2360, -2410, -2461, -2511, -2561, -2611, -2661, -2711, -2761, -2811, -2861, -2911, -2962, -3012, -3062, -3112, -3162, -3212, -3262, -3312, -3362, -3412, -3462, -3512, -3562, -3612, -3662, -3712, -3761, -3811, -3861, -3911, -3961, -4011, -4061, -4111, -4161, -4210, -4260, -4310, -4360, -4410, -4460, -4509, -4559, -4609, -4659, -4708, -4758, -4808, -4858, -4907, -4957, -5007, -5056, -5106, -5156, -5205, -5255, -5305, -5354, -5404, -5453, -5503, -5552, -5602, -5651, -5701, -5750, -5800, -5849, -5899, -5948, -5998, -6047, -6096, -6146, -6195, -6245, -6294, -6343, -6393, -6442, -6491, -6540, -6590, -6639, -6688, -6737, -6786, -6836, -6885, -6934, -6983, -7032, -7081, -7130, -7179, -7228, -7277, -7326, -7375, -7424, -7473, -7522, -7571, -7620, -7669, -7718, -7767, -7815, -7864, -7913, -7962, -8010, -8059, -8108, -8157, -8205, -8254, -8303, -8351, -8400, -8448, -8497, -8545, -8594, -8642, -8691, -8739, -8788, -8836, -8885, -8933, -8981, -9030, -9078, -9126, -9175, -9223, -9271, -9319, -9367, -9416, -9464, -9512, -9560, -9608, -9656, -9704, -9752, -9800, -9848, -9896, -9944, -9992, -10039, -10087, -10135, -10183, -10231, -10278, -10326, -10374, -10421, -10469, -10517, -10564, -10612, -10659, -10707, -10754, -10802, -10849, -10897, -10944, -10992, -11039, -11086, -11133, -11181, -11228, -11275, -11322, -11370, -11417, -11464, -11511, -11558, -11605, -11652, -11699, -11746, -11793, -11840, -11886, -11933, -11980, -12027, -12074, -12120, -12167, -12214, -12260, -12307, -12353, -12400, -12446, -12493, -12539, -12586, -12632, -12679, -12725, -12771, -12817, -12864, -12910, -12956, -13002, -13048, -13094, -13141, -13187, -13233, -13279, -13324, -13370, -13416, -13462, -13508, -13554, -13599, -13645, -13691, -13736, -13782, -13828, -13873, -13919, -13964, -14010, -14055, -14101, -14146, -14191, -14236, -14282, -14327, -14372, -14417, -14462, -14507, -14553, -14598, -14643, -14688, -14732, -14777, -14822, -14867, -14912, -14956, -15001, -15046, -15090, -15135, -15180, -15224, -15269, -15313, -15358, -15402, -15446, -15491, -15535, -15579, -15623, -15667, -15712, -15756, -15800, -15844, -15888, -15932, -15976, -16019, -16063, -16107, -16151, -16195, -16238, -16282, -16325, -16369, -16413, -16456, -16499, -16543, -16586, -16630, -16673, -16716, -16759, -16802,
		-16846, -16889, -16932, -16975, -17018, -17061, -17104, -17146, -17189, -17232, -17275, -17317, -17360, -17403, -17445, -17488, -17530, -17573, -17615, -17657, -17700, -17742, -17784, -17827, -17869, -17911, -17953, -17995, -18037, -18079, -18121, -18163, -18204, -18246, -18288, -18330, -18371, -18413, -18454, -18496, -18537, -18579, -18620, -18661, -18703, -18744, -18785, -18826, -18868, -18909, -18950, -18991, -19032, -19072, -19113, -19154, -19195, -19236, -19276, -19317, -19357, -19398, -19438, -19479, -19519, -19560, -19600, -19640, -19680, -19721, -19761, -19801, -19841, -19881, -19921, -19961, -20000, -20040, -20080, -20120, -20159, -20199, -20238, -20278, -20317, -20357, -20396, -20436, -20475, -20514, -20553, -20592, -20631, -20670, -20709, -20748, -20787, -20826, -20865, -20904, -20942, -20981, -21019, -21058, -21096, -21135, -21173, -21212, -21250, -21288, -21326, -21364, -21403, -21441, -21479, -21516, -21554, -21592, -21630, -21668, -21705, -21743, -21781, -21818, -21856, -21893, -21930, -21968, -22005, -22042, -22079, -22116, -22154, -22191, -22227, -22264, -22301, -22338, -22375, -22411, -22448, -22485, -22521, -22558, -22594, -22631, -22667, -22703, -22739, -22776, -22812, -22848, -22884, -22920, -22956, -22991, -23027, -23063, -23099, -23134, -23170, -23205, -23241, -23276, -23311, -23347, -23382, -23417, -23452, -23487, -23522, -23557, -23592, -23627, -23662, -23697, -23731, -23766, -23801, -23835, -23870, -23904, -23938, -23973, -24007, -24041, -24075, -24109, -24143, -24177, -24211, -24245, -24279, -24312, -24346, -24380, -24413, -24447, -24480, -24514, -24547, -24580, -24613, -24647, -24680, -24713, -24746, -24779, -24811, -24844, -24877, -24910, -24942, -24975, -25007, -25040, -25072, -25105, -25137, -25169, -25201, -25233, -25265, -25297, -25329, -25361, -25393, -25425, -25456, -25488, -25519, -25551, -25582, -25614, -25645, -25676, -25708, -25739, -25770, -25801, -25832, -25863, -25893, -25924, -25955, -25986, -26016, -26047, -26077, -26108, -26138, -26168, -26198, -26229, -26259, -26289, -26319, -26349, -26378, -26408, -26438, -26468, -26497, -26527, -26556, -26586, -26615, -26644, -26674, -26703, -26732, -26761, -26790, -26819, -26848, -26876, -26905, -26934, -26962, -26991, -27019, -27048, -27076, -27104, -27133, -27161, -27189, -27217, -27245, -27273, -27300, -27328, -27356, -27384, -27411, -27439, -27466, -27493, -27521, -27548, -27575, -27602, -27629, -27656, -27683, -27710, -27737, -27764, -27790, -27817, -27843, -27870, -27896, -27923, -27949, -27975, -28001, -28027, -28053, -28079, -28105, -28131, -28157, -28182, -28208, -28234, -28259, -28284, -28310, -28335, -28360, -28385, -28411, -28436, -28460, -28485, -28510, -28535, -28560, -28584, -28609, -28633, -28658, -28682, -28706, -28730, -28755, -28779, -28803, -28827, -28850, -28874, -28898, -28922, -28945, -28969, -28992, -29016, -29039, -29062, -29085, -29108, -29131, -29154, -29177, -29200, -29223, -29246, -29268, -29291, -29313, -29336, -29358, -29380, -29403, -29425, -29447, -29469, -29491, -29513, -29534, -29556, -29578, -29599, -29621, -29642, -29664, -29685, -29706, -29728, -29749, -29770, -29791, -29812, -29832, -29853, -29874, -29894, -29915, -29936,
		-29956, -29976, -29997, -30017, -30037, -30057, -30077, -30097, -30117, -30136, -30156, -30176, -30195, -30215, -30234, -30253, -30273, -30292, -30311, -30330, -30349, -30368, -30387, -30406, -30424, -30443, -30462, -30480, -30498, -30517, -30535, -30553, -30571, -30589, -30607, -30625, -30643, -30661, -30679, -30696, -30714, -30731, -30749, -30766, -30783, -30800, -30818, -30835, -30852, -30868, -30885, -30902, -30919, -30935, -30952, -30968, -30985, -31001, -31017, -31033, -31050, -31066, -31082, -31097, -31113, -31129, -31145, -31160, -31176, -31191, -31206, -31222, -31237, -31252, -31267, -31282, -31297, -31312, -31327, -31341, -31356, -31371, -31385, -31400, -31414, -31428, -31442, -31456, -31470, -31484, -31498, -31512, -31526, -31539, -31553, -31567, -31580, -31593, -31607, -31620, -31633, -31646, -31659, -31672, -31685, -31698, -31710, -31723, -31736, -31748, -31760, -31773, -31785, -31797, -31809, -31821, -31833, -31845, -31857, -31869, -31880, -31892, -31903, -31915, -31926, -31937, -31949, -31960, -31971, -31982, -31993, -32004, -32014, -32025, -32036, -32046, -32057, -32067, -32077, -32087, -32098, -32108, -32118, -32128, -32137, -32147, -32157, -32166, -32176, -32185, -32195, -32204, -32213, -32223, -32232, -32241, -32250, -32258, -32267, -32276, -32285, -32293, -32302, -32310, -32318, -32327, -32335, -32343, -32351, -32359, -32367, -32375, -32382, -32390, -32397, -32405, -32412, -32420, -32427, -32434, -32441, -32448, -32455, -32462, -32469, -32476, -32482, -32489, -32495, -32502, -32508, -32514, -32521, -32527, -32533, -32539, -32545, -32550, -32556, -32562, -32567, -32573, -32578, -32584, -32589, -32594, -32599, -32604, -32609, -32614, -32619, -32624, -32628, -32633, -32637, -32642, -32646, -32650, -32655, -32659, -32663, -32667, -32671, -32674, -32678, -32682, -32685, -32689, -32692, -32696, -32699, -32702, -32705, -32708, -32711, -32714, -32717, -32720, -32722, -32725, -32728, -32730, -32732, -32735, -32737, -32739, -32741, -32743, -32745, -32747, -32748, -32750, -32752, -32753, -32755, -32756, -32757, -32758, -32759, -32760, -32761, -32762, -32763, -32764, -32765, -32765, -32766, -32766, -32766, -32767, -32767, -32767, -32767, -32767, -32767, -32767, -32766, -32766, -32766, -32765, -32765, -32764, -32763, -32762, -32761, -32760, -32759, -32758, -32757, -32756, -32755, -32753, -32752, -32750, -32748, -32747, -32745, -32743, -32741, -32739, -32737, -32735, -32732, -32730, -32728, -32725, -32722, -32720, -32717, -32714, -32711, -32708, -32705, -32702, -32699, -32696, -32692, -32689, -32685, -32682, -32678, -32674, -32671, -32667, -32663, -32659, -32655, -32650, -32646, -32642, -32637, -32633, -32628, -32624, -32619, -32614, -32609, -32604, -32599, -32594, -32589, -32584, -32578, -32573, -32567, -32562, -32556, -32550, -32545, -32539, -32533, -32527, -32521, -32514, -32508, -32502, -32495, -32489, -32482, -32476, -32469, -32462, -32455, -32448, -32441, -32434, -32427, -32420, -32412, -32405, -32397, -32390, -32382, -32375, -32367, -32359, -32351, -32343, -32335, -32327, -32318, -32310, -32302, -32293, -32285, -32276, -32267, -32258, -32250, -32241, -32232, -32223, -32213, -32204, -32195, -32185, -32176, -32166, -32157, -32147,
		-32137, -32128, -32118, -32108, -32098, -32087, -32077, -32067, -32057, -32046, -32036, -32025, -32014, -32004, -31993, -31982, -31971, -31960, -31949, -31937, -31926, -31915, -31903, -31892, -31880, -31869, -31857, -31845, -31833, -31821, -31809, -31797, -31785, -31773, -31760, -31748, -31736, -31723, -31710, -31698, -31685, -31672, -31659, -31646, -31633, -31620, -31607, -31593, -31580, -31567, -31553, -31539, -31526, -31512, -31498, -31484, -31470, -31456, -31442, -31428, -31414, -31400, -31385, -31371, -31356, -31341, -31327, -31312, -31297, -31282, -31267, -31252, -31237, -31222, -31206, -31191, -31176, -31160, -31145, -31129, -31113, -31097, -31082, -31066, -31050, -31033, -31017, -31001, -30985, -30968, -30952, -30935, -30919, -30902, -30885, -30868, -30852, -30835, -30818, -30800, -30783, -30766, -30749, -30731, -30714, -30696, -30679, -30661, -30643, -30625, -30607, -30589, -30571, -30553, -30535, -30517, -30498, -30480, -30462, -30443, -30424, -30406, -30387, -30368, -30349, -30330, -30311, -30292, -30273, -30253, -30234, -30215, -30195, -30176, -30156, -30136, -30117, -30097, -30077, -30057, -30037, -30017, -29997, -29976, -29956, -29936, -29915, -29894, -29874, -29853, -29832, -29812, -29791, -29770, -29749, -29728, -29706, -29685, -29664, -29642, -29621, -29599, -29578, -29556, -29534, -29513, -29491, -29469, -29447, -29425, -29403, -29380, -29358, -29336, -29313, -29291, -29268, -29246, -29223, -29200, -29177, -29154, -29131, -29108, -29085, -29062, -29039, -29016, -28992, -28969, -28945, -28922, -28898, -28874, -28850, -28827, -28803, -28779, -28755, -28730, -28706, -28682, -28658, -28633, -28609, -28584, -28560, -28535, -28510, -28485, -28460, -28436, -28411, -28385, -28360, -28335, -28310, -28284, -28259, -28234, -28208, -28182, -28157, -28131, -28105, -28079, -28053, -28027, -28001, -27975, -27949, -27923, -27896, -27870, -27843, -27817, -27790, -27764, -27737, -27710, -27683, -27656, -27629, -27602, -27575, -27548, -27521, -27493, -27466, -27439, -27411, -27384, -27356, -27328, -27300, -27273, -27245, -27217, -27189, -27161, -27133, -27104, -27076, -27048, -27019, -26991, -26962, -26934, -26905, -26876, -26848, -26819, -26790, -26761, -26732, -26703, -26674, -26644, -26615, -26586, -26556, -26527, -26497, -26468, -26438, -26408, -26378, -26349, -26319, -26289, -26259, -26229, -26198, -26168, -26138, -26108, -26077, -26047, -26016, -25986, -25955, -25924, -25893, -25863, -25832, -25801, -25770, -25739, -25708, -25676, -25645, -25614, -25582, -25551, -25519, -25488, -25456, -25425, -25393, -25361, -25329, -25297, -25265, -25233, -25201, -25169, -25137, -25105, -25072, -25040, -25007, -24975, -24942, -24910, -24877, -24844, -24811, -24779, -24746, -24713, -24680, -24647, -24613, -24580, -24547, -24514, -24480, -24447, -24413, -24380, -24346, -24312, -24279, -24245, -24211, -24177, -24143, -24109, -24075, -24041, -24007, -23973, -23938, -23904, -23870, -23835, -23801, -23766, -23731, -23697, -23662, -23627, -23592, -23557, -23522, -23487, -23452, -23417, -23382, -23347, -23311, -23276, -23241, -23205, -23170, -23134, -23099, -23063, -23027, -22991, -22956, -22920, -22884, -22848, -22812, -22776, -22739, -22703, -22667, -22631,
		-22594, -22558, -22521, -22485, -22448, -22411, -22375, -22338, -22301, -22264, -22227, -22191, -22154, -22116, -22079, -22042, -22005, -21968, -21930, -21893, -21856, -21818, -21781, -21743, -21705, -21668, -21630, -21592, -21554, -21516, -21479, -21441, -21403, -21364, -21326, -21288, -21250, -21212, -21173, -21135, -21096, -21058, -21019, -20981, -20942, -20904, -20865, -20826, -20787, -20748, -20709, -20670, -20631, -20592, -20553, -20514, -20475, -20436, -20396, -20357, -20317, -20278, -20238, -20199, -20159, -20120, -20080, -20040, -20000, -19961, -19921, -19881, -19841, -19801, -19761, -19721, -19680, -19640, -19600, -19560, -19519, -19479, -19438, -19398, -19357, -19317, -19276, -19236, -19195, -19154, -19113, -19072, -19032, -18991, -18950, -18909, -18868, -18826, -18785, -18744, -18703, -18661, -18620, -18579, -18537, -18496, -18454, -18413, -18371, -18330, -18288, -18246, -18204, -18163, -18121, -18079, -18037, -17995, -17953, -17911, -17869, -17827, -17784, -17742, -17700, -17657, -17615, -17573, -17530, -17488, -17445, -17403, -17360, -17317, -17275, -17232, -17189, -17146, -17104, -17061, -17018, -16975, -16932, -16889, -16846, -16802, -16759, -16716, -16673, -16630, -16586, -16543, -16499, -16456, -16413, -16369, -16325, -16282, -16238, -16195, -16151, -16107, -16063, -16019, -15976, -15932, -15888, -15844, -15800, -15756, -15712, -15667, -15623, -15579, -15535, -15491, -15446, -15402, -15358, -15313, -15269, -15224, -15180, -15135, -15090, -15046, -15001, -14956, -14912, -14867, -14822, -14777, -14732, -14688, -14643, -14598, -14553, -14507, -14462, -14417, -14372, -14327, -14282, -14236, -14191, -14146, -14101, -14055, -14010, -13964, -13919, -13873, -13828, -13782, -13736, -13691, -13645, -13599, -13554, -13508, -13462, -13416, -13370, -13324, -13279, -13233, -13187, -13141, -13094, -13048, -13002, -12956, -12910, -12864, -12817, -12771, -12725, -12679, -12632, -12586, -12539, -12493, -12446, -12400, -12353, -12307, -12260, -12214, -12167, -12120, -12074, -12027, -11980, -11933, -11886, -11840, -11793, -11746, -11699, -11652, -11605, -11558, -11511, -11464, -11417, -11370, -11322, -11275, -11228, -11181, -11133, -11086, -11039, -10992, -10944, -10897, -10849, -10802, -10754, -10707, -10659, -10612, -10564, -10517, -10469, -10421, -10374, -10326, -10278, -10231, -10183, -10135, -10087, -10039, -9992, -9944, -9896, -9848, -9800, -9752, -9704, -9656, -9608, -9560, -9512, -9464, -9416, -9367, -9319, -9271, -9223, -9175, -9126, -9078, -9030, -8981, -8933, -8885, -8836, -8788, -8739, -8691, -8642, -8594, -8545, -8497, -8448, -8400, -8351, -8303, -8254, -8205, -8157, -8108, -8059, -8010, -7962, -7913, -7864, -7815, -7767, -7718, -7669, -7620, -7571, -7522, -7473, -7424, -7375, -7326, -7277, -7228, -7179, -7130, -7081, -7032, -6983, -6934, -6885, -6836, -6786, -6737, -6688, -6639, -6590, -6540, -6491, -6442, -6393, -6343, -6294, -6245, -6195, -6146, -6096, -6047, -5998, -5948, -5899, -5849, -5800, -5750, -5701, -5651, -5602, -5552, -5503, -5453, -5404, -5354, -5305, -5255, -5205, -5156, -5106, -5056, -5007, -4957, -4907, -4858,
		-4808, -4758, -4708, -4659, -4609, -4559, -4509, -4460, -4410, -4360, -4310, -4260, -4210, -4161, -4111, -4061, -4011, -3961, -3911, -3861, -3811, -3761, -3712, -3662, -3612, -3562, -3512, -3462, -3412, -3362, -3312, -3262, -3212, -3162, -3112, -3062, -3012, -2962, -2911, -2861, -2811, -2761, -2711, -2661, -2611, -2561, -2511, -2461, -2410, -2360, -2310, -2260, -2210, -2160, -2110, -2059, -2009, -1959, -1909, -1859, -1809, -1758, -1708, -1658, -1608, -1558, -1507, -1457, -1407, -1357, -1307, -1256, -1206, -1156, -1106, -1055, -1005, -955, -905, -854, -804, -754, -704, -653, -603, -553, -503, -452, -402, -352, -302, -251, -201, -151, -101, -50};
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_I2C1_Init(void);
static void MX_I2S3_Init(void);
static void MX_SPI1_Init(void);
static void MX_USB_OTG_FS_PCD_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
void HAL_I2S_TxHalfCpltCallback(I2S_HandleTypeDef *hi2s) {
	HAL_GPIO_TogglePin(GPIOD, LD4_Pin); //green
	outBufPtr = &dacData[0];
	dataReadyFlag = 1;
	//processData(1);
}

void HAL_I2S_TxCpltCallback(I2S_HandleTypeDef *hi2s) {
	HAL_GPIO_TogglePin(GPIOD, LD3_Pin);
	outBufPtr = &dacData[BUFFER_SIZE / 2];
	dataReadyFlag = 1;
	//processData(0);
}

// from googoomuck https://github.com/deadsy/googoomuck/blob/23a4c42d906d39d54b2561419264b4d8862aaff6/ggm/pow.c#L59

//Notes:
//
//math library powf(2.f, x) = 4.58uS
//math library truncf() = 300nS
//
//pow2_frac() = 186nS
//pow2() = 500nS

static const uint16_t exp0_table[64] = {
	0x8000, 0x8165, 0x82ce, 0x843a, 0x85ab, 0x871f, 0x8898, 0x8a15, 0x8b96, 0x8d1b, 0x8ea4, 0x9032, 0x91c4, 0x935a, 0x94f5, 0x9694,
	0x9838, 0x99e0, 0x9b8d, 0x9d3f, 0x9ef5, 0xa0b0, 0xa270, 0xa435, 0xa5ff, 0xa7ce, 0xa9a1, 0xab7a, 0xad58, 0xaf3b, 0xb124, 0xb312,
	0xb505, 0xb6fe, 0xb8fc, 0xbaff, 0xbd09, 0xbf18, 0xc12c, 0xc347, 0xc567, 0xc78d, 0xc9ba, 0xcbec, 0xce25, 0xd063, 0xd2a8, 0xd4f3,
	0xd745, 0xd99d, 0xdbfc, 0xde61, 0xe0cd, 0xe340, 0xe5b9, 0xe839, 0xeac1, 0xed4f, 0xefe5, 0xf281, 0xf525, 0xf7d1, 0xfa84, 0xfd3e,
};

static const uint16_t exp1_table[64] = {
	0x8000, 0x8006, 0x800b, 0x8011, 0x8016, 0x801c, 0x8021, 0x8027, 0x802c, 0x8032, 0x8037, 0x803d, 0x8043, 0x8048, 0x804e, 0x8053,
	0x8059, 0x805e, 0x8064, 0x806a, 0x806f, 0x8075, 0x807a, 0x8080, 0x8085, 0x808b, 0x8090, 0x8096, 0x809c, 0x80a1, 0x80a7, 0x80ac,
	0x80b2, 0x80b8, 0x80bd, 0x80c3, 0x80c8, 0x80ce, 0x80d3, 0x80d9, 0x80df, 0x80e4, 0x80ea, 0x80ef, 0x80f5, 0x80fa, 0x8100, 0x8106,
	0x810b, 0x8111, 0x8116, 0x811c, 0x8122, 0x8127, 0x812d, 0x8132, 0x8138, 0x813e, 0x8143, 0x8149, 0x814e, 0x8154, 0x815a, 0x815f,
};

// return powf(2.f, x) where x is an integer [-126,127]
float pow2_int(int x) {
	float f;
	// make a float32 per IEEE754
	*(uint32_t *) & f = (127 + x) << 23;
	return f;
}

// return powf(2.f, x) where x = [0,1)
float pow2_frac(float x) {
	int n = (int)(x * (float)(1U << 12));
	uint16_t x0 = exp0_table[(n >> 6) & 0x3f];
	uint16_t x1 = exp1_table[n & 0x3f];
	return (float)(x0 * x1) * (1.f / (float)(1U << 30));
}

// return powf(2.f, x)
float pow2(float x) {
	float nf = truncf(x);
	float ff = x - nf;
	if (ff < 0) {
		nf -= 1.f;
		ff += 1.f;
	}
	return pow2_frac(ff) * pow2_int((int)nf);
}

// return powf(e, x)
float powe(float x) {
	return pow2(LOG_E2 * x);
}

// Function to calculate the ADSR envelope value
float adsr_envelope(float time_elapsed, int key_pressed) {
	//TODO bugs in if statements. must modify to keep track of sample state. Becaus
	float amplitude;

	if (key_pressed) { // Key is currently pressed
		if (time_elapsed < ATTACK_TIME) {
			// Attack phase: Linear ramp-up
			amplitude = time_elapsed / ATTACK_TIME;
		} else if (time_elapsed < ATTACK_TIME + 3*DECAY_TIME) {
			// Decay phase: Exponential decay to sustain level
			float time_in_decay = time_elapsed - ATTACK_TIME;
			amplitude = (1.0 - SUSTAIN_LEVEL) * powe(-time_in_decay / DECAY_TIME) + SUSTAIN_LEVEL;
		} else {
			// Sustain phase: Constant sustain level
			amplitude = SUSTAIN_LEVEL;
		}
	} else { // Key is released
		if (time_elapsed > 0) { // Ensure we've had some attack/decay/sustain
			// Release phase: Exponential decay to zero
			float time_in_release = time_elapsed; // Time since release started
			amplitude = SUSTAIN_LEVEL * powe(-time_in_release / RELEASE_TIME);
//			if (amplitude < 0.0001) { // Optional: Clamp to near zero to avoid tiny values
//				amplitude = 0.0;
//			}
		}
	}

	return amplitude;
}

double min(double a, double b) {
	  return (a < b) ? a : b;
}

void processData() {
	//navflag
	if (outBufPtr == &dacData[0]) {
		HAL_GPIO_WritePin(GPIOD, LD6_Pin, GPIO_PIN_SET); //blue
	}
	else {
		HAL_GPIO_WritePin(GPIOD, LD5_Pin, GPIO_PIN_SET); //red
	}
	static float leftOut, rightOut;
	static int16_t leftOutInt, rightOutInt;
	float t;
	float f;
	float tNote;
	float intermediate;
	//double phase;
	uint16_t phase = 0;
	uint16_t M = BUFFER_SIZE/4;
	uint16_t quarter = M/4;
	uint8_t noteInd = ((uint8_t)(loops/1600)) % lenJoy;
	if (noteInd != prevNoteInd) {
		ticksNote = 0;
	}
	prevNoteInd = noteInd;
	//printf("%u\r\n",noteInd);
	f = 440*pow(1.0594630943592952646,odeToJoy[noteInd]); // + 4*sinf(1.5*TAU*t);
	//printf("%d \r\n", odeToJoy[noteInd]);
	for (uint16_t n = 0; n < (BUFFER_SIZE / 2) - 1; n += 2) {

		t = (ticks)/(float)FS;
		tNote = (ticksNote)/(float)FS;

		phase = ((uint16_t)(LOOKUPSIZE *f* t)) % LOOKUPSIZE;
		leftOutInt = (int16_t)(sineLookupTable[phase] * adsr_envelope(tNote, tNote < ATTACK_TIME + 2*DECAY_TIME));

		//rightOut = leftOut;
		outBufPtr[n] = (int16_t) leftOutInt; //(10000 * leftOut); //15k worked, 25k worked, 30k worked, 32767 worked, 32768 OVERFLOWs andcr
		outBufPtr[n + 1] = (int16_t) leftOutInt; //(10000 * rightOut);
		ticks++;
		ticksNote++;

	}
	loops++;
	//	printf("\r\n");
	dataReadyFlag = 0;
	HAL_GPIO_WritePin(GPIOD, LD6_Pin, GPIO_PIN_RESET); //blue
	HAL_GPIO_WritePin(GPIOD, LD5_Pin, GPIO_PIN_RESET); //red

}

// CS43L22 Stereo DAC driver by https://github.com/deadsy/googoomuck/blob/master/drivers/cs43l22.h
enum {
	DAC_OUTPUT_OFF,		// must be 0
	DAC_OUTPUT_SPEAKER,
	DAC_OUTPUT_HEADPHONE,
	DAC_OUTPUT_BOTH,
	DAC_OUTPUT_AUTO,
	DAC_OUTPUT_MAX,		// must be last
};

struct cs4x_cfg {
	//struct i2c_drv *i2c;	// i2c bus
	uint8_t adr;		// device i2c bus address
	//int rst;		// gpio for reset pin
	int out;		// output device
};

struct cs4x_drv {
	struct cs4x_cfg cfg;
};

HAL_StatusTypeDef i2c_wr(uint8_t *buf, uint8_t Nbytes) {
	HAL_StatusTypeDef rc;
	rc = HAL_I2C_Master_Transmit(&hi2c1, DACADDR, buf, Nbytes, HAL_MAX_DELAY);
	return rc;
}

HAL_StatusTypeDef i2c_rd(uint8_t *buf, uint8_t Nbytes) {
	HAL_StatusTypeDef rc;
	rc = HAL_I2C_Master_Receive(&hi2c1, DACADDR, buf, Nbytes, HAL_MAX_DELAY);
	return rc;
}
// read a dac register
static int cs4x_rd(struct cs4x_drv *dac, uint8_t reg, uint8_t *val) {
	uint8_t buf[1] = { reg };
	int rc;
	rc = i2c_wr(buf, 1);
	if (rc != 0) {
		return rc;
	}
	rc = i2c_rd(buf, 1);
	if (rc != 0) {
		return rc;
	}
	*val = buf[0];
	return 0;
}

// write a dac register
static int cs4x_wr(struct cs4x_drv *dac, uint8_t reg, uint8_t val) {
	uint8_t buf[2] = { reg, val };
	return i2c_wr(buf, 2);
}

// read/modify/write a register
static int cs4x_rmw(struct cs4x_drv *dac, uint8_t reg, uint8_t mask,
		uint8_t val) {
	uint8_t x;
	int rc;
	rc = cs4x_rd(dac, reg, &x);
	if (rc != 0) {
		return rc;
	}
	x &= ~mask;
	x |= val & mask;
	return cs4x_wr(dac, reg, x);
}

// set bits in a register
static int cs4x_set(struct cs4x_drv *dac, uint8_t reg, uint8_t bits) {
	return cs4x_rmw(dac, reg, bits, 0xff);
}

// clear bits in a register
static int cs4x_clr(struct cs4x_drv *dac, uint8_t reg, uint8_t bits) {
	return cs4x_rmw(dac, reg, bits, 0);
}

//-----------------------------------------------------------------------------

// read and verify the device id
static int cs4x_id(struct cs4x_drv *dac) {
	uint8_t id;
	int rc;
	rc = cs4x_rd(dac, CS43L22_REG_ID, &id);
	if (rc != 0) {
		return rc;
	}
	if ((id & 0xf8) != 0xe0) {
		return -1;
	}
	return 0;
}

//-----------------------------------------------------------------------------

// set the output device
int cs4x_output(struct cs4x_drv *dac, unsigned int out) {
	const uint8_t ctrl[DAC_OUTPUT_MAX] = { 0xff, 0xfa, 0xaf, 0xaa, 0x05 };
	int rc;
	if (out >= DAC_OUTPUT_MAX) {
		out = DAC_OUTPUT_OFF;
	}
	rc = cs4x_wr(dac, CS43L22_REG_Power_Ctl_2, ctrl[out]);
	if (rc != 0) {
		return rc;
	}
	dac->cfg.out = out;
	return 0;
}

//-----------------------------------------------------------------------------
// volume controls
// Map 0..255 to the control value for a volume register.
// 0 is minium volume (or mute), 255 is maximum volume.

// set the master volume
int cs4x_master_volume(struct cs4x_drv *dac, uint8_t vol) {
	uint32_t x;
	int rc;
	x = (((281 - 52) << 16) / 255) * vol + (52 << 16);
	x >>= 16;
	x &= 255;
	rc = cs4x_wr(dac, CS43L22_REG_Master_A_Vol, x);
	rc |= cs4x_wr(dac, CS43L22_REG_Master_B_Vol, x);
	return rc;
}

// set the headphone volume
int cs4x_headphone_volume(struct cs4x_drv *dac, uint8_t vol) {
	uint32_t x;
	int rc;
	if (vol == 0) {
		x = 1;		// muted
	} else {
		x = (((257 - 52) << 16) / 255) * (vol - 1) + (52 << 16);
		x >>= 16;
		x &= 255;
	}
	rc = cs4x_wr(dac, CS43L22_REG_Headphone_A_Volume, x);
	rc |= cs4x_wr(dac, CS43L22_REG_Headphone_B_Volume, x);
	return rc;
}

// set the speaker volume
int cs4x_speaker_volume(struct cs4x_drv *dac, uint8_t vol) {
	uint32_t x;
	int rc;
	if (vol == 0) {
		x = 1;		// muted
	} else {
		x = (((257 - 64) << 16) / 255) * (vol - 1) + (64 << 16);
		x >>= 16;
		x &= 255;
	}
	rc = cs4x_wr(dac, CS43L22_REG_Speaker_A_Volume, x);
	rc |= cs4x_wr(dac, CS43L22_REG_Speaker_B_Volume, x);
	return rc;
}

// set the pcm volume
int cs4x_pcm_volume(struct cs4x_drv *dac, uint8_t vol) {
	uint32_t x;
	int rc;
	if (vol == 0) {
		x = 0x80;	// muted
	} else {
		x = (((281 - 25) << 16) / (255 - 1)) * (vol - 1) + (25 << 16);
		x >>= 16;
		x &= 255;
	}
	rc = cs4x_wr(dac, CS43L22_REG_PCMA_Vol, x);
	rc |= cs4x_wr(dac, CS43L22_REG_PCMB_Vol, x);
	return rc;
}

//-----------------------------------------------------------------------------
// mute on/off

static int cs4x_mute_on(struct cs4x_drv *dac) {
	int rc = cs4x_wr(dac, CS43L22_REG_Power_Ctl_2, 0xff);
	rc |= cs4x_headphone_volume(dac, 0);
	return rc;
}

static int cs4x_mute_off(struct cs4x_drv *dac) {
	int rc = cs4x_headphone_volume(dac, 0xff);
	rc |= cs4x_output(dac, dac->cfg.out);
	return rc;
}

//-----------------------------------------------------------------------------

int cs4x_init(struct cs4x_drv *dac, struct cs4x_cfg *cfg) {
	int rc;

	memset(dac, 0, sizeof(struct cs4x_drv));
	dac->cfg = *cfg;

	// 4.9 Recommended Power-Up Sequence (1,2)
	// reset the dac
	// DAC Reset is active low, so pull the pin high.
	HAL_GPIO_WritePin(Audio_RST_GPIO_Port, Audio_RST_Pin, GPIO_PIN_RESET);
	HAL_GPIO_WritePin(Audio_RST_GPIO_Port, Audio_RST_Pin, GPIO_PIN_SET);

	rc = cs4x_id(dac);
	if (rc != 0) {
		printf("cs4x bad device id %d\r\n", rc);
		goto exit;
	}
	// 4.9 Recommended Power-Up Sequence (4)
	// 4.11 Required Initialization Settings
	rc |= cs4x_wr(dac, 0, 0x99);
	rc |= cs4x_wr(dac, 0x47, 0x80);
	rc |= cs4x_set(dac, 0x32, 1 << 7);
	rc |= cs4x_clr(dac, 0x32, 1 << 7);
	rc |= cs4x_wr(dac, 0, 0);

	// set the output to AUTO
	rc |= cs4x_output(dac, DAC_OUTPUT_AUTO);
	// Clock configuration: Auto detection
	rc |= cs4x_wr(dac, CS43L22_REG_Clocking_Ctl, 0x81);
	// Set the Slave Mode and the audio Standard
	rc |= cs4x_wr(dac, CS43L22_REG_Interface_Ctl_1, 0x04);

	// Set the Master volume
	rc |= cs4x_master_volume(dac, 169);

	// If the Speaker is enabled, set the Mono mode and volume attenuation level
	if (dac->cfg.out != DAC_OUTPUT_OFF
			&& dac->cfg.out != DAC_OUTPUT_HEADPHONE) {
		// Set the Speaker Mono mode
		rc |= cs4x_wr(dac, CS43L22_REG_Playback_Ctl_2, 0x06);
		rc |= cs4x_speaker_volume(dac, 0xff);
	}
	// Additional configuration for the CODEC. These configurations are done to reduce
	// the time needed for the Codec to power off. If these configurations are removed,
	// then a long delay should be added between powering off the Codec and switching
	// off the I2S peripheral MCLK clock (which is the operating clock for Codec).
	// If this delay is not inserted, then the codec will not shut down properly and
	// it results in high noise after shut down.

	// Disable the analog soft ramp
	rc |= cs4x_rmw(dac, CS43L22_REG_Analog_ZC_and_SR_Settings, 0x0f, 0x00);
	// Disable the digital soft ramp
	rc |= cs4x_wr(dac, CS43L22_REG_Misc_Ctl, 0x04);
	// Disable the limiter attack level
	rc |= cs4x_wr(dac, CS43L22_REG_Limit_Ctl_1_Thresholds, 0x00);
	// Adjust Bass and Treble levels
	rc |= cs4x_wr(dac, CS43L22_REG_Tone_Ctl, 0x0f);
	// Adjust PCM volume level
	rc |= cs4x_pcm_volume(dac, 241);

	exit: return rc;
}

//-----------------------------------------------------------------------------

int cs4x_start(struct cs4x_drv *dac) {
	// Enable the digital soft ramp
	int rc = cs4x_wr(dac, CS43L22_REG_Misc_Ctl, 0x06);
	// Enable Output device
	rc |= cs4x_mute_off(dac);
	// Power on the Codec
	rc |= cs4x_wr(dac, CS43L22_REG_Power_Ctl_1, 0x9e);
	return rc;
}

int cs4x_stop(struct cs4x_drv *dac) {
	// Mute the output
	int rc = cs4x_mute_on(dac);
	// Disable the digital soft ramp
	rc |= cs4x_wr(dac, CS43L22_REG_Misc_Ctl, 0x04);
	// Power down the DAC and the speaker (PMDAC and PMSPK bits)
	rc |= cs4x_wr(dac, CS43L22_REG_Power_Ctl_1, 0x9f);
	return rc;
}

int cs4x_pause(struct cs4x_drv *dac) {
	// Mute the output
	int rc = cs4x_mute_on(dac);
	// Put the Codec in Power save mode
	rc |= cs4x_wr(dac, CS43L22_REG_Power_Ctl_1, 0x01);
	return rc;
}

int cs4x_resume(struct cs4x_drv *dac) {
	// Unmute the output
	int rc = cs4x_mute_off(dac);
	// Power on the Codec
	rc |= cs4x_wr(dac, CS43L22_REG_Power_Ctl_1, 0x9e);
	return rc;
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */
	uint8_t buf[12];

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_I2C1_Init();
  MX_I2S3_Init();
  MX_SPI1_Init();
  MX_USB_OTG_FS_PCD_Init();
  /* USER CODE BEGIN 2 */


	// EXT DAC INTIIALIZATION
	struct cs4x_cfg cfgdac;
	cfgdac.adr = DACADDR;
	cfgdac.out = DAC_OUTPUT_HEADPHONE;
	struct cs4x_drv dac;
	int rc = cs4x_init(&dac, &cfgdac);
	printf("CS4X init returned %d\r\n", rc);
	rc = cs4x_start(&dac);
	printf("CS4X start returned %d\r\n", rc);

	HAL_Delay(1);

	HAL_StatusTypeDef res;

	// Attempt to transmit audio data to DAC
	processData();
	outBufPtr = &dacData[BUFFER_SIZE/2];
	processData();
	//outBufPtr = &dacData[BUFFER_SIZE / 2];
	//processData();
	res = HAL_I2S_Transmit_DMA(&hi2s3, (uint16_t*) dacData, BUFFER_SIZE);
	//res = HAL_I2S_Transmit(&hi2s3, (uint16_t*) signal, nsamples,HAL_MAX_DELAY);
	if (res != HAL_OK) {
		printf("I2S - ERROR, res = %d!\r\n", res);
	}
	printf("loops after first two processes: %ld\r\n", (long)loops);

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
	while (1) {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */

		if (dataReadyFlag) {
			processData();

		}

	}

  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 336;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 7;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief I2C1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2C1_Init(void)
{

  /* USER CODE BEGIN I2C1_Init 0 */

  /* USER CODE END I2C1_Init 0 */

  /* USER CODE BEGIN I2C1_Init 1 */

  /* USER CODE END I2C1_Init 1 */
  hi2c1.Instance = I2C1;
  hi2c1.Init.ClockSpeed = 100000;
  hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
  hi2c1.Init.OwnAddress1 = 0;
  hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
  hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
  hi2c1.Init.OwnAddress2 = 0;
  hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
  hi2c1.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
  if (HAL_I2C_Init(&hi2c1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2C1_Init 2 */

  /* USER CODE END I2C1_Init 2 */

}

/**
  * @brief I2S3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2S3_Init(void)
{

  /* USER CODE BEGIN I2S3_Init 0 */

  /* USER CODE END I2S3_Init 0 */

  /* USER CODE BEGIN I2S3_Init 1 */

  /* USER CODE END I2S3_Init 1 */
  hi2s3.Instance = SPI3;
  hi2s3.Init.Mode = I2S_MODE_MASTER_TX;
  hi2s3.Init.Standard = I2S_STANDARD_PHILIPS;
  hi2s3.Init.DataFormat = I2S_DATAFORMAT_16B;
  hi2s3.Init.MCLKOutput = I2S_MCLKOUTPUT_ENABLE;
  hi2s3.Init.AudioFreq = I2S_AUDIOFREQ_48K;
  hi2s3.Init.CPOL = I2S_CPOL_LOW;
  hi2s3.Init.ClockSource = I2S_CLOCK_PLL;
  hi2s3.Init.FullDuplexMode = I2S_FULLDUPLEXMODE_DISABLE;
  if (HAL_I2S_Init(&hi2s3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2S3_Init 2 */

  /* USER CODE END I2S3_Init 2 */

}

/**
  * @brief SPI1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI1_Init(void)
{

  /* USER CODE BEGIN SPI1_Init 0 */

  /* USER CODE END SPI1_Init 0 */

  /* USER CODE BEGIN SPI1_Init 1 */

  /* USER CODE END SPI1_Init 1 */
  /* SPI1 parameter configuration*/
  hspi1.Instance = SPI1;
  hspi1.Init.Mode = SPI_MODE_MASTER;
  hspi1.Init.Direction = SPI_DIRECTION_2LINES;
  hspi1.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi1.Init.NSS = SPI_NSS_SOFT;
  hspi1.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_2;
  hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi1.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi1.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi1.Init.CRCPolynomial = 10;
  if (HAL_SPI_Init(&hspi1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI1_Init 2 */

  /* USER CODE END SPI1_Init 2 */

}

/**
  * @brief USB_OTG_FS Initialization Function
  * @param None
  * @retval None
  */
static void MX_USB_OTG_FS_PCD_Init(void)
{

  /* USER CODE BEGIN USB_OTG_FS_Init 0 */

  /* USER CODE END USB_OTG_FS_Init 0 */

  /* USER CODE BEGIN USB_OTG_FS_Init 1 */

  /* USER CODE END USB_OTG_FS_Init 1 */
  hpcd_USB_OTG_FS.Instance = USB_OTG_FS;
  hpcd_USB_OTG_FS.Init.dev_endpoints = 4;
  hpcd_USB_OTG_FS.Init.speed = PCD_SPEED_FULL;
  hpcd_USB_OTG_FS.Init.dma_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.phy_itface = PCD_PHY_EMBEDDED;
  hpcd_USB_OTG_FS.Init.Sof_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.low_power_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.lpm_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.vbus_sensing_enable = ENABLE;
  hpcd_USB_OTG_FS.Init.use_dedicated_ep1 = DISABLE;
  if (HAL_PCD_Init(&hpcd_USB_OTG_FS) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USB_OTG_FS_Init 2 */

  /* USER CODE END USB_OTG_FS_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Stream5_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream5_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* USER CODE BEGIN MX_GPIO_Init_1 */

  /* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOE_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(CS_I2C_SPI_GPIO_Port, CS_I2C_SPI_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(OTG_FS_PowerSwitchOn_GPIO_Port, OTG_FS_PowerSwitchOn_Pin, GPIO_PIN_SET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOD, LD4_Pin|LD3_Pin|LD5_Pin|LD6_Pin
                          |Audio_RST_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin : CS_I2C_SPI_Pin */
  GPIO_InitStruct.Pin = CS_I2C_SPI_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(CS_I2C_SPI_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : OTG_FS_PowerSwitchOn_Pin */
  GPIO_InitStruct.Pin = OTG_FS_PowerSwitchOn_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(OTG_FS_PowerSwitchOn_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : PDM_OUT_Pin */
  GPIO_InitStruct.Pin = PDM_OUT_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI2;
  HAL_GPIO_Init(PDM_OUT_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : B1_Pin */
  GPIO_InitStruct.Pin = B1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_EVT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(B1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : BOOT1_Pin */
  GPIO_InitStruct.Pin = BOOT1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(BOOT1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : CLK_IN_Pin */
  GPIO_InitStruct.Pin = CLK_IN_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI2;
  HAL_GPIO_Init(CLK_IN_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : LD4_Pin LD3_Pin LD5_Pin LD6_Pin */
  GPIO_InitStruct.Pin = LD4_Pin|LD3_Pin|LD5_Pin|LD6_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pin : Audio_RST_Pin */
  GPIO_InitStruct.Pin = Audio_RST_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_PULLUP;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(Audio_RST_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : OTG_FS_OverCurrent_Pin */
  GPIO_InitStruct.Pin = OTG_FS_OverCurrent_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(OTG_FS_OverCurrent_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : MEMS_INT2_Pin */
  GPIO_InitStruct.Pin = MEMS_INT2_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_EVT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(MEMS_INT2_GPIO_Port, &GPIO_InitStruct);

  /* USER CODE BEGIN MX_GPIO_Init_2 */

  /* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
int _write(int file, char *ptr, int len) {
	(void) file;
	int DataIdx;

	for (DataIdx = 0; DataIdx < len; DataIdx++) {
		ITM_SendChar(*ptr++);
	}
	return len;
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
	/* User can add his own implementation to report the HAL error return state */
	__disable_irq();
	while (1) {
		printf("Error\r\n");
	}
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
	/* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
